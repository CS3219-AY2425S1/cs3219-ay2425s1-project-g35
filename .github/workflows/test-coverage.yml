name: Test Coverage

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [ChatService, QuestionService, UserService/user-service]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install
        working-directory: ./${{ matrix.service }}

      - name: Run test coverage
        run: npm run test:coverage
        working-directory: ./${{ matrix.service }}

      - name: Set sanitized service name
        run: echo "SANITIZED_SERVICE_NAME=${{ matrix.service }}" | sed 's|/|_|g' >> $GITHUB_ENV

      - name: Upload coverage report
        if: success() && steps.verify.outputs.coverage-exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SANITIZED_SERVICE_NAME }}-coverage
          path: ${{ matrix.service }}/coverage

  aggregate:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Download coverage reports
        uses: actions/download-artifact@v3
        with:
          name: '*-coverage'

      - name: Merge coverage reports
        run: |
          npm install -g nyc
          nyc merge $(find . -name 'coverage-final.json') > coverage/coverage-summary.json

      - name: Upload combined coverage report
        uses: actions/upload-artifact@v4
        with:
          name: combined-coverage
          path: coverage
